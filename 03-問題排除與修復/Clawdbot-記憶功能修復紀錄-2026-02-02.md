# Clawdbot 記憶功能修復紀錄（2026-02-02）

本文件記錄此次修復「長期記憶（Memory）unavailable」的完整過程，供日後參考或還原使用。

---

## 1. 問題現象

- `clawdbot status` 顯示：**Memory │ enabled (plugin memory-core) · unavailable**
- Bot 回覆：記憶搜尋顯示 API 金鑰錯誤，無法存取長期記憶

---

## 2. 錯誤的設定方式（會報錯）

曾嘗試用以下指令設定 embedding 模型，**會失敗**：

```bash
clawdbot config set agents.defaults.model.embedding "google/text-embedding-004"
# Error: Config validation failed: agents.defaults.model: Unrecognized key: "embedding"
```

**原因**：`agents.defaults.model` 在 schema 裡只接受 `primary` 和 `fallbacks`（對話用 LLM），不包含 `embedding`。

---

## 3. 正確的 Embedding 設定

Embedding 模型是給**記憶搜尋（memory search）**用的，要寫在 `agents.defaults.memorySearch`：

```bash
# 設定 provider（Gemini）
clawdbot config set agents.defaults.memorySearch.provider "gemini"

# 設定 embedding 模型
clawdbot config set agents.defaults.memorySearch.model "google/text-embedding-004"
```

若版本不支援 `google/text-embedding-004`，可改用：

```bash
clawdbot config set agents.defaults.memorySearch.model "gemini-embedding-001"
```

改完後需 **重啟 gateway**：`clawdbot gateway restart`

---

## 4. 記憶仍 unavailable：API 金鑰問題

設定完 provider/model 後，Memory 仍顯示 unavailable，Bot 回報「API 金鑰錯誤」。

**原因**：記憶搜尋使用 **Gemini Embedding API**，需要 **Google API 金鑰**。僅有 OAuth（如 google-antigravity、google-gemini-cli）不足以提供 embedding，必須有一組 **API Key** 型態的 Google 金鑰。

---

## 5. auth-profiles.json 位置與用途

- **本機實際使用路徑**：`~/.clawdbot/agents/main/agent/auth-profiles.json`
- **備份路徑**：`備份指南/clawdbot-backup/agents/main/agent/auth-profiles.json`

Bot 會從這裡讀取各 provider 的認證。記憶搜尋需要的是一組 **google + type: api_key** 的 profile（例如 `google:default`）。

---

## 6. 解法：加入 Google API 金鑰（免費金鑰可沿用）

- 使用 **免費的 Google API 金鑰**（如 Google AI Studio 發的）即可，僅供 **embedding（記憶搜尋）** 使用，不影響對話模型（GPT / Claude 等）。
- 將金鑰寫入本機的 `~/.clawdbot/agents/main/agent/auth-profiles.json`：

在 `profiles` 中新增或修正：

```json
"google:default": {
  "type": "api_key",
  "provider": "google",
  "key": "你的_Google_API_金鑰"
}
```

在 `lastGood` 中確保有：

```json
"google": "google:default"
```

存檔後執行：`clawdbot gateway restart`

---

## 7. 修復結果

重啟後 `clawdbot status` 的 Memory 行顯示為：

```
Memory │ 3 files · 10 chunks · dirty · sources memory · plugin memory-core · vector ready · fts ready · cache on (10)
```

表示：

- 已索引 3 個記憶檔、10 個 chunks
- 向量搜尋（vector）與全文搜尋（fts）皆就緒
- embedding 快取已啟用（10 筆）
- 長期記憶功能可正常使用

---

## 8. 若出現「gemini batch failed」404 錯誤

日誌出現：

```
[memory] embeddings: gemini batch failed; ... asyncBatchEmbedContent not available for this model/baseUrl.
Disable remote.batch.enabled or switch providers.
```

**原因**：免費 API 或該 embedding 模型不支援 Gemini 的「非同步批次 embedding」介面。

**解法**：關閉記憶搜尋的遠端批次，改用一般（非批次）embedding：

在 `~/.clawdbot/clawdbot.json` 的 `agents.defaults.memorySearch` 裡加上：

```json
"remote": {
  "batch": {
    "enabled": false
  }
}
```

或執行：

```bash
clawdbot config set agents.defaults.memorySearch.remote.batch.enabled false
```

存檔或設定後執行：`clawdbot gateway restart`。之後仍會用 Gemini 做 embedding，只是改為逐次請求，不再打 batch API，錯誤即不再出現。

---

## 9. 日後若換機或重裝可參考

1. **Embedding 設定**：用 `agents.defaults.memorySearch.provider` 與 `agents.defaults.memorySearch.model`，勿用 `agents.defaults.model.embedding`。
2. **金鑰**：在 `~/.clawdbot/agents/main/agent/auth-profiles.json` 保留或還原 `google:default`（api_key），或改設環境變數 `GEMINI_API_KEY`。
3. **重啟**：任何 config 或 auth 變更後執行 `clawdbot gateway restart`。

---

*紀錄日期：2026-02-02*
